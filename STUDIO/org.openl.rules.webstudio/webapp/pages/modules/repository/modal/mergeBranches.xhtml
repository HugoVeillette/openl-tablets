<ui:composition
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:a4j="http://richfaces.org/a4j"
        xmlns:rich="http://richfaces.org/rich"
        xmlns:ui="http://java.sun.com/jsf/facelets">

    <rich:popupPanel id="modalMergeBranches" autosized="true">
        <f:facet name="header">
            <h:outputText value="Sync changes"/>
        </f:facet>

        <f:facet name="controls">
            <h:graphicImage value="/images/close.gif" class="close" alt="Close" title="Close"
                            onclick="RichFaces.$('modalMergeBranches').hide();"/>
        </f:facet>

        <h:form id="mergeBranchesForm">
            <h:panelGroup id="modalMergeBranchesData">
                <h:inputHidden id="hiddenProjectName" value="#{branchesBean.currentProjectName}"/>

                <p>
                    <h:panelGrid columns="2" styleClass="formfields" cellspacing="1" columnClasses="label,">
                        <h:outputText value="Current branch:"/>
                        <h:outputText value="#{branchesBean.currentBranch}"/>

                        <h:outputText value="Merge with:"/>
                        <h:selectOneMenu id="branchToMerge" value="#{branchesBean.branchToMerge}">
                            <f:selectItems value="#{branchesBean.branchesToMerge}"/>
                        </h:selectOneMenu>
                    </h:panelGrid>
                </p>
            </h:panelGroup>

            <footer>
                <a4j:commandButton value="Import their changes"
                                   title="Get the latest changes from the chosen branch to #{branchesBean.currentBranch}"
                                   render="projectTree nodeView @form"
                                   data="#{studio.mergeConflict}"
                                   action="#{branchesBean.mergeImport}" styleClass="button-primary"
                                   oncomplete="onMergeComplete(event.data, #{!facesContext.validationFailed});"/>
                <a4j:commandButton value="Export your changes"
                                   title="Apply changes from #{branchesBean.currentBranch} to chosen branch"
                                   render="projectTree nodeView @form"
                                   data="#{studio.mergeConflict}"
                                   action="#{branchesBean.mergeExport}" styleClass="button-primary"
                                   oncomplete="onMergeComplete(event.data, #{!facesContext.validationFailed});"/>
                <input type="button" value="Cancel" onclick="RichFaces.$('modalMergeBranches').hide();"/>
            </footer>

            <a4j:jsFunction name="renderMergeBranchesForm" render="mergeBranchesForm"
                            oncomplete="showMergeBranchesDialog()">
                <a4j:param name="projectName" assignTo="#{branchesBean.initProject}"/>
            </a4j:jsFunction>

            <a4j:jsFunction name="refreshRepositoryAfterMerge" render="projectTree nodeView">
                <a4j:param name="wasMerged" assignTo="#{branchesBean.wasMerged}"/>
            </a4j:jsFunction>
        </h:form>

    </rich:popupPanel>

    <script>
        //<![CDATA[

        function openMergeBranchesDialog(projectName) {
            renderMergeBranchesForm(projectName);
        }

        function showMergeBranchesDialog() {
            RichFaces.$("modalMergeBranches").show();
        }

        function onMergeComplete(mergeConflict, successful) {
            if (mergeConflict) {
                RichFaces.$('modalMergeBranches').hide();
                openResolveConflictDialog(refreshRepositoryAfterMerge);
            } else if (successful) {
                RichFaces.$('modalMergeBranches').hide();
            }
        }

        //]]>
    </script>
</ui:composition>
