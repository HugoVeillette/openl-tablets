<?xml version="1.0" encoding="UTF-8"?>
<ui:composition
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    template="/pages/layout/simpleLayout.xhtml"
    xmlns:a4j="http://richfaces.org/a4j">

    <ui:define name="content">
    <style>
        .installMessages ul {
            margin: 0;
            padding: 0;
            list-style-type: none;
        }

        select, input[type='text'], input[type='password'] {
            width: 20em;
        }

        #adBlock table tr td:first-child {
            min-width: 145px;
        }

        #user-mode-block-selector > div {
            display: table-cell;
            vertical-align: top;
        }

        #user-mode-block-selector > .field-edit {
            width: 40%;
        }

        #user-mode-block-selector > .field-description {
            padding: 10px;
            background-color: #f2f2f2;
        }
        #user-mode-block-selector > .field-description > p {
            margin: 0;

            /* Default value to reduce blinking. Is changed by js when the page is loaded. */
            display: none;
        }

    </style>

        <div class="wizard-page">
            <div class="wizard-page-container">
                <h:form id="step3Form">
                    <div class="wizard-block" id="usermodeBlock">
                        <h3>Select user mode:
                            <div class="field-description">
                                <p>User mode defines how many users can run the application and where user projects will be located by default.</p>
                            </div>
                        </h3>
                        <div id="user-mode-block-selector">
                            <div class="field-edit">
                                <h:selectOneRadio value="#{installWizard.userMode}" layout="pageDirection" >
                                    <f:selectItem itemValue="single" itemLabel="Single-user" />
                                    <f:selectItem itemValue="multi" itemLabel="Multi-user" />
                                    <f:selectItem itemValue="ad" itemLabel="Active Directory" />
                                    <f:selectItem itemValue="cas" itemLabel="Central Authentication Service (CAS)" />
                                    <f:selectItem itemValue="demo" itemLabel="Demo" />
                                </h:selectOneRadio>
                            </div><!-- Remove whitespace between nearby divs
                         --><div class="field-description">
                                <p class="user-mode-single">Only the currently logged in user can run OpenL Tablets WebStudio. All user projects will be saved in the root of the '#{installWizard.workingDir}#{installWizard.folderSeparator}user-workspace' directory.</p>
                                <p class="user-mode-multi">Multiple users can run OpenL Tablets WebStudio using their unique user names. The User’s projects will be located in the '#{installWizard.workingDir}#{installWizard.folderSeparator}user-workspace#{installWizard.folderSeparator}USERNAME' folder. User credentials are managed inside WebStudio.</p>
                                <p class="user-mode-ad">Multiple users can run OpenL Tablets WebStudio using their unique user names. The User’s projects will be located in the '#{installWizard.workingDir}#{installWizard.folderSeparator}user-workspace#{installWizard.folderSeparator}USERNAME' folder. Active Directory will be used to authenticate and manage user credentials.</p>
                                <p class="user-mode-cas">Multiple users can run OpenL Tablets WebStudio using their unique user names. The User’s projects will be located in the '#{installWizard.workingDir}#{installWizard.folderSeparator}user-workspace#{installWizard.folderSeparator}USERNAME' folder. CAS server be used to authenticate and manage user credentials.</p>
                                <p class="user-mode-demo">You will use an internal User Database with predefined list of users. All changes in the database will be lost after the application restart. The User’s projects will be located in the '#{installWizard.workingDir}#{installWizard.folderSeparator}user-workspace#{installWizard.folderSeparator}USERNAME' folder.</p>
                            </div>
                        </div>
                    </div>
                    <div class="wizard-block" id="adBlock">
                        <h3>Configure Active Directory:
                            <div class="field-description">
                                <p>Set up an Active Directory to use for managing users in OpenL Tablets WebStudio.<br />
                                   Please contact your System Administrator for this information if necessary.</p>
                            </div>
                        </h3>
                        <div>
                            <table>
                                <tr>
                                    <td colspan="2">
                                        <a4j:outputPanel styleClass="installMessages" ajaxRendered="true">
                                            <h:messages infoClass="success" errorClass="error" showDetail="true"
                                                showSummary="false" tooltip="true" globalOnly="true" />
                                            <h:message  class="error" for="adPassword" />
                                        </a4j:outputPanel>
                                        <span id="ad-successful-message" class="success" style="display:none">Connection successful</span>
                                    </td>
                                   </tr>
                                <tr>
                                    <td><label>Active Directory domain:</label></td>
                                    <td>
                                        <h:inputText id="adDomain" value="#{installWizard.adDomain}" size="40"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td><label>Active Directory URL:</label></td>
                                    <td>
                                        <h:inputText id="adUrl" value="#{installWizard.adUrl}" size="40"/>
                                    </td>
                                </tr>
                            </table>

                            <div class="field-description">
                                <p>Login and Password are used to check connection to Active Directory. They will not be saved anywhere.</p>
                            </div>

                            <table>
                                <tr>
                                    <td><label>Login:</label></td>
                                    <td>
                                        <h:inputText id="adUsername" value="#{installWizard.adUsername}" size="40"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td><label>Password:</label></td>
                                    <td>
                                        <h:inputSecret id="adPassword" value="#{installWizard.adPassword}" size="40" validator="#{installWizard.adValidator}"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td>
                                        <a4j:commandButton id="adConnectionCheck"
                                                           value="Check connection"
                                                           execute="adDomain adUrl adUsername adPassword"
                                                           oncomplete="toggleBlock('#ad-successful-message', #{!facesContext.validationFailed});"/>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="wizard-block" id="casBlock">
                        <h3>Configure Central Authentication Service (CAS):
                            <div class="field-description">
                                <p>Set up a Central Authentication Service (CAS) to use for managing users in OpenL Tablets WebStudio.<br />
                                    Please contact your System Administrator for this information if necessary.</p>
                            </div>
                        </h3>
                        <div>
                            <table>
                                <tr>
                                    <td colspan="2">
                                        <a4j:outputPanel styleClass="installMessages" ajaxRendered="true">
                                            <h:messages infoClass="success" errorClass="error" showDetail="true"
                                                        showSummary="false" tooltip="true" globalOnly="true" />
                                            <h:message  class="error" for="casGroupsAttribute" />
                                        </a4j:outputPanel>
                                    </td>
                                </tr>
                                <tr>
                                    <td><label>WebStudio server URL:</label></td>
                                    <td>
                                        <h:inputText id="webStudioUrl" value="#{installWizard.casSettings.webStudioUrl}" size="40"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td><label>CAS server url:</label></td>
                                    <td>
                                        <h:inputText id="casServerUrl" value="#{installWizard.casSettings.casServerUrl}" size="40"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td><label>Attribute for First Name:</label></td>
                                    <td>
                                        <h:inputText id="casFirstNameAttribute" value="#{installWizard.casSettings.firstNameAttribute}" size="40"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td><label>Attribute for Second Name:</label></td>
                                    <td>
                                        <h:inputText id="casSecondNameAttribute" value="#{installWizard.casSettings.secondNameAttribute}" size="40"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td><label>Attribute for Groups:</label></td>
                                    <td>
                                        <h:inputText id="casGroupsAttribute" value="#{installWizard.casSettings.groupsAttribute}" size="40"/>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="wizard-block" id="dbBlock">
                        <h3>Configure database:
                            <div class="field-description">
                                <p>Set up a database to be used for managing users in OpenL Tablets WebStudio.<br />
                                    Please contact your System Administrator for this information if necessary.</p>
                            </div>
                        </h3>
                        <div>
                            <table>

                                <tr>
                                    <td colspan="2">
                                        <a4j:outputPanel styleClass="installMessages" ajaxRendered="true">
                                            <h:messages infoClass="success" errorClass="error" showDetail="true"
                                                        showSummary="false" tooltip="true" globalOnly="true" />
                                            <h:message  class="error" for="dbPassword" />
                                        </a4j:outputPanel>
                                    </td>
                                </tr>
                                <tr>
                                    <td><label>Database type:</label></td>
                                    <td>
                                        <h:selectOneMenu value="#{installWizard.dbVendor}" id="dbVendor" immediate="true">
                                            <f:selectItem itemValue="#{null}" itemLabel="Select one"/>
                                            <f:selectItems value="#{installWizard.DBVendors}" />
                                            <f:ajax  listener="#{installWizard.dbVendorChanged}" />
                                            <f:ajax render="dbUrl dbUsername"/>
                                        </h:selectOneMenu>
                                    </td>
                                </tr>
                                <tr>
                                    <td><label>Database URL:</label></td>
                                    <td>
                                        <h:inputText id="dbUrl" value="#{installWizard.dbUrl}" size="40" >
                                            <f:ajax  listener="#{installWizard.urlChanged}" />
                                        </h:inputText>
                                    </td>
                                </tr>
                                <tr><td></td></tr>
                                <tr><td></td></tr>
                                <tr>
                                    <td><label>Login:</label></td>
                                    <td>
                                        <h:inputText id="dbUsername" value="#{installWizard.dbUsername}" size="40">
                                            <f:ajax  listener="#{installWizard.usernameChanged}" />
                                        </h:inputText>
                                    </td>
                                </tr>
                                <tr>
                                    <td><label>Password:</label></td>
                                    <td>
                                        <h:inputSecret id="dbPassword" value="#{installWizard.dbPassword}" size="40"
                                                       redisplay="true"
                                                       validator="#{installWizard.dbValidator}"/>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>


                    <div class="wizard-buttons" id="finish-buttons">
                        <h:commandButton id="prevButton" value="Prev" action="#{installWizard.prev}" onclick="showLoader()" immediate="true" />
                        <h:commandButton value="Finish" action="#{installWizard.finish}" class="button-primary" onclick="showLoader()" />
                        <span style="color:#7b1">Click 'Finish' to complete the installation process</span>
                    </div>
                    <div class="wizard-buttons" id="next-buttons">
                        <h:commandButton id="prevButtonAd" value="Prev" action="#{installWizard.prev}" onclick="showLoader()" immediate="true" />
                        <h:commandButton value="Next" action="#{installWizard.next}" class="button-primary" onclick="showLoader()" />
                    </div>
                </h:form>
            </div>
        </div>

        <script>
            //<![CDATA[

            // TODO Move to UI JS model
            function toggleBlock(selector, toggle) {
                $j(selector).toggle(toggle);
                $j(selector + " input")
                    .not("input[type='radio']")
                    .not("input[type='submit']")
                    .prop('disabled', !toggle);
            }

            (function() {
                var toggleVisibleBlocks = function () {
                    var userMode = $j("#usermodeBlock input:checked").val();

                    toggleBlock("#dbBlock", userMode !== "single" && userMode !== "demo");

                    toggleBlock("#adBlock", userMode === "ad");
                    toggleBlock("#casBlock", userMode === "cas");

                    toggleBlock("#finish-buttons", userMode !== "ad" && userMode !== "cas");
                    toggleBlock("#next-buttons", userMode === "ad" || userMode === "cas");

                    $j("#user-mode-block-selector .field-description > p").hide();
                    $j("#user-mode-block-selector .field-description > p.user-mode-" + userMode).show();
                };

                var updateCheckConnectionButton = function () {
                    var username = $j("#step3Form\\:adUsername").val();
                    var password = $j("#step3Form\\:adPassword").val();
                    // Disable the button if username and password are empty
                    var isBlank = !username || !password || /^\s*$/.test(username);
                    $j("#step3Form\\:adConnectionCheck").prop('disabled', isBlank);
                };

                toggleVisibleBlocks();
                updateCheckConnectionButton();

                $j("#usermodeBlock input").change(function() {
                    toggleVisibleBlocks();
                });

                $j("#step3Form\\:adUsername").on("change keyup cut paste", function () {
                    updateCheckConnectionButton();
                });
                $j("#step3Form\\:adPassword").on("change keyup cut paste", function () {
                    updateCheckConnectionButton();
                });

            })();

            //]]>
        </script>

    </ui:define>
</ui:composition>
