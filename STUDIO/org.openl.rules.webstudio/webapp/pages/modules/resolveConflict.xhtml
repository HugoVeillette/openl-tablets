<ui:composition
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:a4j="http://richfaces.org/a4j"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:ui="http://java.sun.com/jsf/facelets">

  <c:set var="contextPath" value="#{facesContext.externalContext.request.contextPath}" />

  <rich:popupPanel id="modalResolveConflicts" width="580" autosized="true">
    <f:facet name="header">
      <h:outputText value="Resolve conflicts" />
    </f:facet>

    <f:facet name="controls">
      <h:graphicImage value="/images/close.gif" class="close" alt="Close" title="Close" onclick="closeResolveConflictDialog();" />
    </f:facet>

    <h:form id="resolveConflictsForm">
      <h:panelGroup id="modalResolveConflictsData">
        <h:panelGrid columns="2" styleClass="formfields" cellspacing="1" columnClasses="label,">
          <h:outputText value="Our version:"/>
          <h:outputText value="#{mergeConflictBean.ourCommit}"/>

          <h:outputText value="Their version:"/>
          <h:outputText value="#{mergeConflictBean.theirCommit}"/>

          <h:outputText value="Base version:"/>
          <h:outputText value="#{mergeConflictBean.baseCommit}"/>

          <h:outputText value="Comment:"/>
          <h:inputTextarea value="#{mergeConflictBean.mergeMessage}" type="text" size="35" readonly="false">
            <f:ajax execute="@this"/>
          </h:inputTextarea>

          <h:outputText value="Conflicts:"/>
          <h:outputText value=""/>
        </h:panelGrid>

        <rich:dataTable value="#{mergeConflictBean.conflictedFiles}" var="conflict" rowKeyVar="row" styleClass="table">
          <rich:column>
            <f:facet name="header">
              <h:outputText value="File" />
            </f:facet>
            <h:outputText value="#{conflict}" title="#{conflict}"/>
          </rich:column>
          <rich:column style="min-width: 80px">
            <f:facet name="header">
              <h:outputText value="Compare"/>
            </f:facet>
            <div>
              <a href="#{contextPath}/web/file-download/local?name=#{conflict}"
                 title="Download our version">Download Our</a>
            </div>
            <div>
              <a href="#{contextPath}/web/file-download/repository?name=#{conflict}&amp;version=#{mergeConflictBean.theirCommit}"
                 title="Download their version">Download Their</a>
            </div>
            <div>
              <a href="#{contextPath}/web/file-download/repository?name=#{conflict}&amp;version=#{mergeConflictBean.baseCommit}"
                 title="Download base version">Download Base</a>
            </div>
          </rich:column>
          <rich:column style="min-width: 160px">
            <f:facet name="header">
              <h:outputText value="Resolve" />
            </f:facet>
            <h:selectOneRadio value="#{mergeConflictBean.conflictResolutions[conflict].resolutionType}"
                              layout="pageDirection" onchange="return uploadConflictResolution('#{conflict}', this)">
              <f:selectItem itemValue="OURS" itemLabel="Use our"/>
              <f:selectItem itemValue="THEIRS" itemLabel="Use their"/>
              <f:selectItem itemValue="CUSTOM" itemLabel="Upload merged file"/>
              <f:ajax execute="@this"/>
            </h:selectOneRadio>
          </rich:column>
        </rich:dataTable>

      </h:panelGroup>

      <footer>
        <a4j:commandButton value="Save" action="#{mergeConflictBean.saveAndResolve}" render="@form" styleClass="button-primary"
                           oncomplete="if (#{!facesContext.validationFailed}) {closeResolveConflictDialog();}"/>
        <input class="restore-changed-state" type="button" value="Cancel" onclick="closeResolveConflictDialog();" />
      </footer>

      <a4j:jsFunction name="refreshResolveConflictDialog" action="#{mergeConflictBean.init}" render="@form" oncomplete="showResolveConflictDialog();" />
      <a4j:jsFunction name="closeResolveConflictDialog" action="#{mergeConflictBean.clearMergeStatus}" oncomplete="RichFaces.$('modalResolveConflicts').hide();" />
      <a4j:jsFunction name="setConflictAndUploadConflictResolution" oncomplete="openUploadConflictResolutionDialog();">
        <a4j:param name="conflict" assignTo="#{mergeConflictBean.currentConflictedFile}" />
      </a4j:jsFunction>
    </h:form>

  </rich:popupPanel>

  <script>
      //<![CDATA[
      function openResolveConflictDialog() {
        refreshResolveConflictDialog();
      }

      function showResolveConflictDialog() {
        RichFaces.$("modalResolveConflicts").show();
      }

      function uploadConflictResolution(conflict, resolutionElement) {
        if (resolutionElement.value === "CUSTOM" && resolutionElement.checked) {
          setConflictAndUploadConflictResolution(conflict);
          return false;
        }
        return true;
      }
      //]]>
  </script>
</ui:composition>
